<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì£¼ë£¨ë§ˆë¸” TV</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background: #111; margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; color: white; }
        
        #board { 
            width: 90vh; height: 90vh; position: relative; 
            background: url('board.png') no-repeat center/contain;
            border: 2px solid #333;
        }

        .token { position: absolute; font-size: 40px; transition: 0.5s; text-shadow: 0 5px 10px black; z-index: 10; }
        .token .name { font-size: 12px; background: rgba(0,0,0,0.7); padding: 2px 5px; border-radius: 5px; display: block; text-align: center; color: white; }

        /* ì£¼ì‚¬ìœ„ ì•Œë¦¼ */
        #diceToast { position: fixed; top: 10%; left: 50%; transform: translate(-50%, 0); background: rgba(0,0,0,0.8); padding: 20px 40px; border-radius: 20px; font-size: 40px; border: 3px solid #ffd700; display: none; z-index: 100; }

        /* ê´€ë¦¬ì íŒ¨ë„ */
        #adminPanel { position: fixed; right: -300px; top: 0; width: 260px; height: 100%; background: #222; border-left: 3px solid #4cd964; transition: 0.3s; padding: 20px; z-index: 999; }
        #adminPanel.show { right: 0; }
        button { width: 100%; padding: 15px; margin: 5px 0; cursor: pointer; font-weight: bold; background: #444; color: white; border: 1px solid #666; }
        button:hover { background: #4cd964; color: black; }
    </style>
</head>
<body>

    <div id="board">
        </div>

    <div id="diceToast">ğŸ² ì£¼ì‚¬ìœ„: 6</div>

    <div id="adminPanel">
        <h2 style="color:#4cd964">ê´€ë¦¬ì(M)</h2>
        <button onclick="triggerEvent('âš”ï¸ ê²°íˆ¬(VS) ëª¨ë“œ!')">âš”ï¸ ê²°íˆ¬ ëª¨ë“œ ì‹œì‘</button>
        <button onclick="triggerEvent('ğŸ° ëœë¤ ê²Œì„!')">ğŸ° ëœë¤ ê²Œì„ ì‹œì‘</button>
        <button onclick="triggerSpy()">ğŸ•µï¸ ëœë¤ ìŠ¤íŒŒì´ ì§€ì •</button>
        <button onclick="triggerBomb()">ğŸ’£ í­íƒ„ ìƒì„± (12ë²ˆì¹¸)</button>
        <button onclick="giveMasterKey()">ğŸ‘‘ ê¼´ì°Œì—ê²Œ ë§ˆìŠ¤í„°í‚¤</button>
        <button onclick="resetGame()" style="background:#ff3b30">ğŸ”„ ì´ˆê¸°í™”</button>
    </div>

    <script src="game_config.js"></script>
    <script>
        const db = firebase.database();
        
        window.addEventListener('keydown', e => {
            if(e.key === 'm' || e.key === 'M') document.getElementById('adminPanel').classList.toggle('show');
        });

        // 1. ìœ ì € ë§ ê·¸ë¦¬ê¸°
        db.ref('users').on('value', snap => {
            const users = snap.val();
            const board = document.getElementById('board');
            board.innerHTML = ''; 

            if(users) {
                Object.keys(users).forEach(key => {
                    const u = users[key];
                    const charInfo = GAME_CONFIG.characters.find(c=>c.id === u.char);
                    
                    const div = document.createElement('div');
                    div.className = 'token';
                    let statusIcon = '';
                    if(u.status === 'bomb') statusIcon = 'ğŸ’£';
                    if(u.status === 'master') statusIcon = 'ğŸ‘‘';
                    if(u.status === 'spy') statusIcon = 'ğŸ•µï¸';

                    div.innerHTML = `${statusIcon}<br>${charInfo ? charInfo.emoji : 'ğŸ˜€'}<span class="name">${u.name}</span>`;
                    
                    // ë§ ìœ„ì¹˜ (ëœë¤ ë¶„ì‚°)
                    div.style.left = (50 + (Math.random()*20 - 10)) + '%';
                    div.style.top = (50 + (Math.random()*20 - 10)) + '%';
                    
                    board.appendChild(div);
                });
            }
        });

        // 2. ì£¼ì‚¬ìœ„ êµ´ë¦¼ ê°ì§€
        db.ref('diceRoll').on('value', snap => {
            const val = snap.val();
            if(val && (Date.now() - val.time < 3000)) { // 3ì´ˆ ì´ë‚´ ê²ƒë§Œ í‘œì‹œ
                const toast = document.getElementById('diceToast');
                toast.innerText = `${val.name}ë‹˜ ì£¼ì‚¬ìœ„: ${val.num}`;
                toast.style.display = 'block';
                setTimeout(()=> toast.style.display='none', 3000);
            }
        });

        // --- ê´€ë¦¬ì ê¸°ëŠ¥ ---
        function triggerEvent(msg) {
            db.ref('gameEvent').set({ message: msg, time: Date.now() });
        }

        function triggerSpy() {
            db.ref('users').once('value', snap => {
                const ids = Object.keys(snap.val());
                const randomId = ids[Math.floor(Math.random() * ids.length)];
                db.ref('users/' + randomId).update({status: 'spy'});
                triggerEvent('ğŸ•µï¸ ìŠ¤íŒŒì´ê°€ ì¹¨íˆ¬í–ˆìŠµë‹ˆë‹¤!');
            });
        }

        function triggerBomb() {
            db.ref('users').once('value', snap => {
                const ids = Object.keys(snap.val());
                const randomId = ids[Math.floor(Math.random() * ids.length)];
                db.ref('users/' + randomId).update({status: 'bomb'});
                triggerEvent('ğŸ’£ ëˆ„êµ°ê°€ì—ê²Œ í­íƒ„ì´ ìƒê²¼ìŠµë‹ˆë‹¤!');
            });
        }

        function giveMasterKey() {
            db.ref('users').once('value', snap => {
                let max = -1; let id = null;
                snap.forEach(c => {
                    if(c.val().drinks >= max) { max = c.val().drinks; id = c.key; }
                });
                if(id) {
                    db.ref('users/'+id).update({status: 'master'});
                    triggerEvent('ğŸ‘‘ ê¼´ì°Œì—ê²Œ ë§ˆìŠ¤í„°í‚¤ ë¶€ì—¬!');
                }
            });
        }

        function resetGame() {
            if(confirm('ì •ë§ ì´ˆê¸°í™”?')) db.ref('/').remove();
        }
    </script>
</body>
</html>