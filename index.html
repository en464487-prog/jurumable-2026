<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JURUMABLE PLAYER</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* === [Design System: Dark & Neon] === */
        :root { 
            --bg: #121212; 
            --card: #1e1e1e; 
            --point: #4cd964; /* Neon Green */
            --danger: #ff3b30; /* Neon Red */
            --gold: #ffd700;   /* Gold */
            --destiny: #bf5af2; /* Purple for Destiny */
            --text: #ffffff;
        }
        
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 20px; margin: 0; user-select: none; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        
        /* ìœ í‹¸ë¦¬í‹° */
        .hidden { display: none !important; }
        .box { background: var(--card); padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid #333; }
        h2 { margin: 0 0 15px 0; font-size: 20px; font-weight: 700; color: var(--point); text-shadow: 0 0 10px rgba(76, 217, 100, 0.3); }
        
        /* ì…ë ¥ í¼ */
        input { width: 100%; background: transparent; border: none; border-bottom: 2px solid #555; color: white; font-size: 20px; text-align: center; padding: 10px; outline: none; transition: 0.3s; }
        input:focus { border-bottom-color: var(--point); }

        /* ìºë¦­í„° ê·¸ë¦¬ë“œ */
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .char-item { background: #2a2a2a; padding: 10px; border-radius: 12px; font-size: 30px; filter: grayscale(1); transition: 0.2s; border: 2px solid transparent; cursor: pointer; }
        .char-item.active { filter: grayscale(0); border-color: var(--point); background: rgba(76, 217, 100, 0.1); transform: scale(1.1); box-shadow: 0 0 15px rgba(76, 217, 100, 0.4); }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn { background: var(--point); color: #000; width: 100%; padding: 18px; border: none; border-radius: 14px; font-size: 18px; font-weight: 800; margin-top: 15px; cursor: pointer; box-shadow: 0 0 20px rgba(76, 217, 100, 0.4); transition: 0.2s; }
        .btn:active { transform: scale(0.95); opacity: 0.9; }
        .btn.danger { background: var(--danger); box-shadow: 0 0 20px rgba(255, 59, 48, 0.4); color: white; }
        .btn.gold { background: var(--gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }

        /* íƒœê·¸ ì„ íƒ */
        .tag-container { display: flex; gap: 8px; justify-content: center; margin-top: 15px; }
        .tag { padding: 8px 16px; background: #333; border-radius: 20px; font-size: 13px; color: #aaa; border: 1px solid transparent; }
        .tag.active { border-color: var(--point); color: var(--point); background: rgba(76, 217, 100, 0.1); }

        /* === [Game UI] === */
        /* ìƒë‹¨ ìƒíƒœë°” (ë§ˆìŠ¤í„°í‚¤/ìš´ëª…) */
        #status-bar { display: flex; flex-direction: column; gap: 5px; align-items: center; margin-bottom: 20px; }
        .badge { font-size: 13px; padding: 5px 12px; border-radius: 20px; font-weight: bold; animation: popIn 0.3s; display: none; }
        .badge.master { background: var(--gold); color: black; box-shadow: 0 0 10px var(--gold); }
        .badge.destiny { background: var(--destiny); color: white; box-shadow: 0 0 10px var(--destiny); }
        .badge.spy { background: orange; color: black; border: 1px solid white; }

        /* ë©”ì¸ ì•¡ì…˜ ë²„íŠ¼ (ë§¥ë™ íš¨ê³¼) */
        #action-container { min-height: 80px; display: flex; justify-content: center; align-items: center; margin: 20px 0; }
        .pulse-btn { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); } }

        /* í•˜ë‹¨ ê³ ì •ë°” (ì£¼ëŸ‰ & ì¸ë²¤í† ë¦¬) */
        .bottom-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; pointer-events: none; }
        .drink-counter { background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; border: 1px solid #555; font-weight: bold; font-size: 15px; color: var(--point); }
        .inventory-btn { pointer-events: auto; background: var(--card); width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold); display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); position: relative; }
        .inv-badge { position: absolute; top: -5px; right: -5px; background: red; color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* ìŠ¤íŒŒì´ ì˜ì‹¬ ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨ ì‘ê²Œ) */
        .spy-vote-trigger { position: absolute; top: 15px; right: 15px; background: #333; color: #888; border: 1px solid #555; padding: 5px 10px; border-radius: 8px; font-size: 11px; }

        /* === [Modals & Overlays] === */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        
        /* ê²½ê³  ëª¨ë‹¬ */
        .modal.danger-mode { background: rgba(40, 0, 0, 0.95); border: 4px solid var(--danger); }
        .alert-icon { font-size: 80px; margin-bottom: 20px; animation: shake 0.5s infinite; }
        .alert-title { font-size: 32px; color: var(--danger); font-weight: 900; margin-bottom: 10px; text-transform: uppercase; }
        .alert-desc { color: #fff; font-size: 18px; line-height: 1.5; }

        /* ë¦¬ìŠ¤íŠ¸ ì„ íƒ ëª¨ë‹¬ */
        #select-list, #inv-list { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 60vh; overflow-y: auto; }
        .select-item { background: #333; padding: 15px; border-radius: 10px; border: 1px solid #444; color: white; font-weight: bold; }
        .select-item:active { background: var(--point); color: black; }
        
        /* ì¸ë²¤í† ë¦¬ ì•„ì´í…œ */
        .inv-item { background: #2a2a2a; border: 1px solid var(--gold); padding: 15px; border-radius: 10px; text-align: center; }
        .inv-item h4 { margin: 0 0 5px 0; color: var(--gold); }
        .inv-item button { width: 100%; padding: 8px; margin-top: 5px; background: #444; border: none; color: white; border-radius: 5px; }

        /* ë£° ì…ë ¥ì°½ */
        textarea { width: 100%; height: 120px; background: #222; border: 1px solid #555; color: white; padding: 15px; font-size: 16px; border-radius: 10px; margin: 20px 0; box-sizing: border-box; resize: none; }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-2px, 2px); } 75% { transform: translate(2px, -2px); } }
    </style>
</head>
<body>
    <audio id="snd-turn" src="turn_alert.mp3"></audio>
    <audio id="snd-alert" src="sniper.mp3"></audio>
    <audio id="snd-bomb" src="bomb_tick.mp3" loop></audio>

    <div id="login-ui">
        <div style="margin-bottom: 30px;">
            <h1 style="color:white; font-size: 24px; margin:0;">JURUMABLE</h1>
            <p style="color:var(--point); font-size:12px; margin-top:5px; letter-spacing: 2px;">PLAYER CONTROLLER</p>
        </div>

        <div class="box">
            <input type="text" id="userName" placeholder="ë‹‰ë„¤ì„ (5ì ì´ë‚´)" maxlength="5">
            <div class="tag-container" id="tag-list">
                <div class="tag" onclick="selectTag(this, '21')">21í•™ë²ˆ</div>
                <div class="tag" onclick="selectTag(this, '23')">23í•™ë²ˆ</div>
                <div class="tag" onclick="selectTag(this, 'Guest')">ê²ŒìŠ¤íŠ¸</div>
            </div>
        </div>

        <p style="color:#777; font-size:12px;">ìºë¦­í„° ì„ íƒ</p>
        <div class="char-grid" id="char-grid"></div>
        <button class="btn" onclick="enterGame()">ì…ì¥í•˜ê¸°</button>
    </div>

    <div id="game-ui" class="hidden">
        <button class="spy-vote-trigger" onclick="openVote()">âš ï¸ ì˜ì‹¬ íˆ¬í‘œ</button>
        
        <div id="status-bar">
            <div id="badge-master" class="badge master">ğŸ‘‘ ë§ˆìŠ¤í„° í‚¤ í™œì„±í™” (1í„´)</div>
            <div id="badge-destiny" class="badge destiny">ğŸ”— ìš´ëª… ê³µë™ì²´ (3í„´)</div>
            <div id="badge-spy" class="badge spy"></div>
        </div>

        <div style="margin-top: 20px;">
            <div id="my-char-display" style="font-size: 50px; margin-bottom: 10px;">ğŸ˜€</div>
            <h2 id="my-name-display" style="color:white; margin:0;">í”Œë ˆì´ì–´</h2>
            <p id="game-msg" style="color:#888; font-size:14px; margin-top:5px;">ëŒ€ê¸° ì¤‘...</p>
        </div>

        <div id="action-container"></div>

        <div class="bottom-bar">
            <div class="drink-counter">ğŸº <span id="drink-count">0</span>ì” (Auto)</div>
            <div class="inventory-btn" onclick="openInventory()">
                ğŸ’
                <div id="inv-count" class="inv-badge hidden">0</div>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal danger-mode" onclick="closeModal('alert-modal')">
        <div class="alert-icon" id="alert-emoji">âš ï¸</div>
        <div class="alert-title" id="alert-title">ê²½ê³ </div>
        <div class="alert-desc" id="alert-desc">ë‚´ìš©</div>
    </div>

    <div id="inv-modal" class="modal">
        <h2 style="color:var(--gold)">ğŸ’ ë‚´ ê°€ë°©</h2>
        <div id="inv-list"></div>
        <button class="btn" style="background:#444; margin-top:20px;" onclick="closeModal('inv-modal')">ë‹«ê¸°</button>
    </div>

    <div id="select-modal" class="modal">
        <h2 id="select-title" style="color:white">ëŒ€ìƒ ì„ íƒ</h2>
        <div id="select-list"></div>
        <button class="btn" style="background:#444; margin-top:20px;" onclick="closeModal('select-modal')">ì·¨ì†Œ</button>
    </div>

    <div id="input-modal" class="modal">
        <h2 style="color:var(--gold)">ğŸ“œ ë²•ì˜ ì§€ë°°ì</h2>
        <p style="color:#ccc; font-size:14px;">ìƒˆë¡œìš´ ê·œì¹™ì„ ì„ í¬í•˜ì„¸ìš”.</p>
        <textarea id="rule-text" placeholder="ì˜ˆ: ì§€ê¸ˆë¶€í„° ì›ƒìœ¼ë©´ 1ì”"></textarea>
        <button class="btn" onclick="submitRule()">TV ì†¡ì¶œí•˜ê¸°</button>
    </div>

    <script src="game_config.js"></script>
    <script>
        // === [1] ì´ˆê¸° ì„¤ì • ===
        let db, myId, myChar, myTag, myName;
        let myInventory = []; 
        let currentMode = null; // 'vote', 'sniper', 'knight'
        let lastDestiny = null; // ìš´ëª…ê³µë™ì²´ ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€

        // ìºë¦­í„° ë¡œë“œ
        window.onload = () => {
            const grid = document.getElementById('char-grid');
            GAME_CONFIG.characters.forEach(c => {
                let d = document.createElement('div');
                d.className = 'char-item';
                d.innerText = c.emoji;
                d.onclick = () => {
                    document.querySelectorAll('.char-item').forEach(e => e.classList.remove('active'));
                    d.classList.add('active');
                    myChar = c.id;
                    navigator.vibrate?.(10);
                };
                grid.appendChild(d);
            });
        };

        function selectTag(el, val) {
            myTag = val;
            document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        }

        // === [2] ì…ì¥ ë° Firebase ì—°ë™ ===
        function enterGame() {
            myName = document.getElementById('userName').value;
            if(!myName || !myChar || !myTag) return alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            // ì˜¤ë””ì˜¤ ê¶Œí•œ íšë“ (ë¬´ìŒ ì¬ìƒ)
            document.getElementById('snd-turn').play().catch(()=>{});

            db = firebase.database();
            myId = Date.now().toString();

            // ìœ ì € ìƒì„±
            db.ref('users/' + myId).set({
                name: myName,
                tag: myTag,
                char: myChar,
                drinks: 0,
                location: 0,
                status: 'alive',
                inventory: [] // ë³´ê´€í•¨ ì´ˆê¸°í™”
            });

            // í™”ë©´ ì „í™˜
            document.getElementById('login-ui').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('my-name-display').innerText = myName;
            document.getElementById('my-char-display').innerText = GAME_CONFIG.characters.find(c=>c.id===myChar).emoji;

            startListening();
        }

        // === [3] ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (ìë™í™”ì˜ í•µì‹¬) ===
        function startListening() {
            db.ref('users/' + myId).on('value', snap => {
                const val = snap.val();
                if(!val) return;

                // 1. ìë™ ì£¼ëŸ‰ ì—…ë°ì´íŠ¸
                document.getElementById('drink-count').innerText = val.drinks || 0;

                // 2. ì¸ë²¤í† ë¦¬ ë™ê¸°í™” (í°ì—ë§Œ ì €ì¥)
                myInventory = val.inventory || [];
                const badge = document.getElementById('inv-count');
                if(myInventory.length > 0) {
                    badge.innerText = myInventory.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

                // 3. ë§ˆìŠ¤í„° í‚¤ (1í„´ ìœ ì§€)
                const masterBadge = document.getElementById('badge-master');
                if(val.masterKeyActive) {
                    masterBadge.style.display = 'block';
                } else {
                    masterBadge.style.display = 'none';
                }

                // 4. ìš´ëª… ê³µë™ì²´ (3í„´ ìœ ì§€ & ì•Œë¦¼)
                const destinyBadge = document.getElementById('badge-destiny');
                if(val.destiny && val.destiny.turns > 0) {
                    destinyBadge.style.display = 'block';
                    destinyBadge.innerText = `ğŸ”— ${val.destiny.partner}ë‹˜ê³¼ ê³µë™ì²´ (${val.destiny.turns}í„´)`;
                    
                    // ìƒˆë¡œìš´ ìš´ëª…ì´ë©´ ì•Œë¦¼
                    if(lastDestiny !== val.destiny.partner) {
                        showAlert('ğŸ”—', 'ìš´ëª… ê³µë™ì²´ ê²°ì„±!', `${val.destiny.partner}ë‹˜ê³¼ ìš´ëª…ì„ í•¨ê»˜í•©ë‹ˆë‹¤.\n(3í„´ê°„ ì§€ì†)`, true);
                        lastDestiny = val.destiny.partner;
                    }
                } else {
                    destinyBadge.style.display = 'none';
                    lastDestiny = null;
                }

                // 5. ìŠ¤íŒŒì´ ë¯¸ì…˜
                const spyBadge = document.getElementById('badge-spy');
                if(val.spyMission) {
                    spyBadge.style.display = 'block';
                    spyBadge.innerText = `ğŸ•µï¸ ë¯¸ì…˜: ${val.spyMission}`;
                } else {
                    spyBadge.style.display = 'none';
                }

                // 6. í­íƒ„ ì•Œë¦¼
                if(val.hasBomb) {
                    document.body.style.border = "5px solid red";
                    document.getElementById('snd-bomb').play();
                    showAlert('ğŸ’£', 'í­íƒ„ì´ ì™”ìŠµë‹ˆë‹¤!', 'ëˆ„êµ°ê°€ë¥¼ ì¶”ì›”í•˜ê±°ë‚˜ í„´ì„ ë„˜ê¸°ì„¸ìš”!', true);
                } else {
                    document.body.style.border = "none";
                    document.getElementById('snd-bomb').pause();
                }

                // 7. ë©”ì¸ ì•¡ì…˜ ë²„íŠ¼ ê´€ë¦¬ (ì£¼ì‚¬ìœ„ / ëŒë¦¬ê¸°)
                const container = document.getElementById('action-container');
                container.innerHTML = ''; // ì´ˆê¸°í™”

                if(val.isMyTurn) {
                    const btn = createActionBtn('ğŸ² ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°', 'btn pulse-btn', () => {
                        const num = Math.floor(Math.random() * 6) + 1;
                        db.ref('game/dice').set({ playerId: myId, num: num, time: Date.now() });
                        db.ref(`users/${myId}/isMyTurn`).set(false);
                    });
                    container.appendChild(btn);
                    playSound('turn');
                    navigator.vibrate?.([200, 100, 200]);
                    document.getElementById('game-msg').innerText = "ë‚´ ì°¨ë¡€ì…ë‹ˆë‹¤!";
                }
                else if(val.actionRequired === 'spin') {
                    const btn = createActionBtn('ğŸ° ëŒë¦¬ê¸°', 'btn gold pulse-btn', () => {
                        db.ref('game/event').set({ type: 'spin_trigger', playerId: myId, time: Date.now() });
                        db.ref(`users/${myId}/actionRequired`).set(null);
                    });
                    container.appendChild(btn);
                    document.getElementById('game-msg').innerText = "ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”!";
                    navigator.vibrate?.(100);
                } else {
                    document.getElementById('game-msg').innerText = "ëŒ€ê¸° ì¤‘...";
                }

                // 8. ìš”ì²­ ì²˜ë¦¬ (ì…ë ¥/ì§€ëª©) - ë§ˆìŠ¤í„°í‚¤ ë“±
                if(val.requestInput) {
                    if(val.requestInput.type === 'rule') {
                        document.getElementById('input-modal').style.display = 'flex';
                    }
                    if(val.requestInput.type === 'select') {
                        currentMode = val.requestInput.mode; // 'sniper', 'knight'
                        openPlayerSelect(val.requestInput.title || 'ëŒ€ìƒ ì„ íƒ');
                    }
                }
                
                // 9. ì „ì—­ ê²½ê³  (Hostê°€ ë³´ë‚¸ ê¸´ê¸‰ ì•Œë¦¼)
                if(val.alertMsg) {
                    showAlert(val.alertEmoji, val.alertTitle, val.alertMsg, true);
                    db.ref(`users/${myId}/alertMsg`).set(null); // í™•ì¸ í›„ ì‚­ì œ
                }
            });
        }

        // === [4] ì•¡ì…˜ í•¨ìˆ˜ë“¤ ===

        // ì¸ë²¤í† ë¦¬ ì—´ê¸°
        function openInventory() {
            const list = document.getElementById('inv-list');
            list.innerHTML = '';
            
            if(myInventory.length === 0) {
                list.innerHTML = '<p style="grid-column: span 2; color:#777;">ë³´ê´€í•¨ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.</p>';
            } else {
                myInventory.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'inv-item';
                    div.innerHTML = `
                        <h4>${item.name}</h4>
                        <p style="font-size:12px; color:#aaa; margin-bottom:5px;">${item.desc}</p>
                    `;
                    const useBtn = document.createElement('button');
                    useBtn.innerText = "ì§€ê¸ˆ ì‚¬ìš©";
                    useBtn.onclick = () => useItem(item, idx);
                    div.appendChild(useBtn);
                    list.appendChild(div);
                });
            }
            document.getElementById('inv-modal').style.display = 'flex';
        }

        // ì•„ì´í…œ ì‚¬ìš© ë¡œì§
        function useItem(item, idx) {
            // 1. íƒ€ê²Ÿ ì§€ì •ì´ í•„ìš”í•œ ì•„ì´í…œì¸ì§€ í™•ì¸
            if(item.type === 'sniper' || item.type === 'attack') {
                currentMode = 'item_use'; // ëª¨ë“œ ì„¤ì •
                // ì„ì‹œ ì €ì¥ì„ ìœ„í•´ ì „ì—­ ë³€ìˆ˜ í™œìš© ê°€ëŠ¥
                window.selectedItemIdx = idx;
                window.selectedItem = item;
                closeModal('inv-modal');
                openPlayerSelect(`${item.name} ì‚¬ìš© ëŒ€ìƒ`);
            } else {
                // 2. ì¦‰ì‹œ ì‚¬ìš© (ë°©ì–´ê¶Œ ë“±) -> Hostë¡œ ì „ì†¡ (TV ì—°ì¶œ)
                db.ref('game/event').set({
                    type: 'item_used',
                    playerId: myId,
                    itemName: item.name,
                    itemEffect: item.effect,
                    time: Date.now()
                });
                // ì¸ë²¤í† ë¦¬ì—ì„œ ì‚­ì œ
                removeItem(idx);
                closeModal('inv-modal');
            }
        }

        function removeItem(idx) {
            let newInv = [...myInventory];
            newInv.splice(idx, 1);
            db.ref(`users/${myId}/inventory`).set(newInv);
        }

        // ì˜ì‹¬ íˆ¬í‘œ ì—´ê¸°
        function openVote() {
            currentMode = 'vote';
            openPlayerSelect('ìŠ¤íŒŒì´ ì˜ì‹¬ ì§€ëª©');
        }

        // í”Œë ˆì´ì–´ ì„ íƒ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        function openPlayerSelect(title) {
            const list = document.getElementById('select-list');
            document.getElementById('select-title').innerText = title;
            list.innerHTML = 'ë¡œë”© ì¤‘...';
            document.getElementById('select-modal').style.display = 'flex';

            db.ref('users').once('value', snap => {
                list.innerHTML = '';
                snap.forEach(u => {
                    if(u.key === myId) return; // ë³¸ì¸ ì œì™¸
                    if(u.val().status === 'dead') return; // ì£½ì€ ì‚¬ëŒ ì œì™¸

                    const btn = document.createElement('div');
                    btn.className = 'select-item';
                    btn.innerText = u.val().name;
                    btn.onclick = () => submitSelect(u.key, u.val().name);
                    list.appendChild(btn);
                });
            });
        }

        // ì„ íƒ ì™„ë£Œ ì²˜ë¦¬
        function submitSelect(targetId, targetName) {
            const payload = {
                from: myId,
                fromName: myName,
                targetId: targetId,
                targetName: targetName,
                time: Date.now()
            };

            if(currentMode === 'vote') {
                payload.type = 'vote_cast';
                db.ref('game/event').set(payload);
                alert(`${targetName}ë‹˜ì—ê²Œ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤.`);
            } 
            else if (currentMode === 'sniper' || currentMode === 'knight') {
                // ë§ˆìŠ¤í„°í‚¤/ì €ê²©ê¶Œ ì‚¬ìš© -> Hostê°€ ì²˜ë¦¬
                payload.type = currentMode + '_action';
                db.ref('game/event').set(payload);
                db.ref(`users/${myId}/requestInput`).set(null); // ìš”ì²­ ë‹«ê¸°
            }
            else if (currentMode === 'item_use') {
                // ë³´ê´€í•¨ ì•„ì´í…œ ì‚¬ìš©
                payload.type = 'item_used_target';
                payload.item = window.selectedItem;
                db.ref('game/event').set(payload);
                removeItem(window.selectedItemIdx);
            }

            closeModal('select-modal');
        }

        // ë£° ì§€ë°°ì ì œì¶œ
        function submitRule() {
            const txt = document.getElementById('rule-text').value;
            if(!txt) return;
            db.ref('game/rule').set({ text: txt, author: myName, time: Date.now() });
            db.ref(`users/${myId}/requestInput`).set(null);
            closeModal('input-modal');
        }

        // === [5] UI ìœ í‹¸ë¦¬í‹° ===
        function createActionBtn(text, className, onClick) {
            const b = document.createElement('button');
            b.className = className;
            b.innerText = text;
            b.onclick = onClick;
            return b;
        }

        function showAlert(emoji, title, desc, vibrate) {
            const m = document.getElementById('alert-modal');
            document.getElementById('alert-emoji').innerText = emoji;
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-desc').innerText = desc;
            m.style.display = 'flex';
            
            if(vibrate) {
                playSound('alert');
                navigator.vibrate?.([500, 200, 500, 200, 500]);
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function playSound(id) { document.getElementById('snd-'+id).play().catch(()=>{}); }

    </script>
</body>
</html>