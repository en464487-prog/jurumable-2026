<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JURUMABLE PLAYER - FINAL GOLD</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        :root { --bg: #f4f7f6; --text: #2d3436; --point: #00b894; --danger: #ff7675; --gold: #fdcb6e; --blue: #0984e3; --purple: #6c5ce7; --dark: #2d3436;}
        
        body { font-family: 'Pretendard', sans-serif; background: radial-gradient(circle at center, #fdfbfb 0%, #ebedee 100%); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; overscroll-behavior-y: contain; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        #login-screen { width: 100%; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; }
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 90%; margin: 20px 0; }
        .char-btn { background: white; border: 2px solid #dfe6e9; border-radius: 15px; font-size: 2rem; padding: 10px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .char-btn.selected { border-color: var(--point); background: #e3fdf5; transform: scale(1.1); box-shadow: 0 0 15px rgba(0, 184, 148, 0.3); }
        input { padding: 15px; border-radius: 12px; border: 1px solid #dfe6e9; margin: 8px; font-size: 1rem; width: 80%; background: white; outline: none; text-align: center; }
        
        #game-screen { width: 100%; max-width: 500px; padding: 20px 0; display: none; flex-direction: column; align-items: center; overflow-y: auto; padding-top: 80px; }
        
        .card { background: rgba(255,255,255,0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); transform: translateZ(0); padding: 20px; border-radius: 25px; width: 85%; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid white; position: relative; }
        
        #dice-btn { width: 180px; height: 180px; border-radius: 50%; background: linear-gradient(145deg, #ff7675, #d63031); border: 5px solid white; font-size: 5rem; color: white; box-shadow: 0 15px 35px rgba(255, 118, 117, 0.4); cursor: pointer; transition: transform 0.1s; margin: 20px 0; display: flex; justify-content: center; align-items: center; will-change: transform; }
        #dice-btn:active { transform: scale(0.95); }
        #dice-btn:disabled { background: #b2bec3; box-shadow: none; cursor: not-allowed; opacity: 0.5; filter: grayscale(100%); }
        
        .ctrl-btn { width: 100%; padding: 20px; border-radius: 15px; border: none; font-size: 1.2rem; font-weight: 900; color: white; margin-bottom: 10px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.1); animation: popUp 0.3s; }
        #slot-trigger-btn { background: var(--gold); display: none; }
        #roulette-trigger-btn { background: var(--blue); display: none; }

        #spy-panel { width: 85%; padding: 20px; background: white; border-radius: 20px; border: 2px solid var(--danger); box-shadow: 0 10px 30px rgba(255, 118, 117, 0.2); display: none; margin-bottom: 20px; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: white; width: 85%; max-height: 80%; overflow-y: auto; border-radius: 25px; padding: 25px; text-align: center; }
        .item-btn, .target-btn { width: 100%; padding: 15px; margin: 5px 0; background: white; border: 1px solid #dfe6e9; border-radius: 12px; font-weight: bold; }
        
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .special-btn { width: 85%; padding: 15px; border-radius: 15px; border: none; font-size: 1.1rem; font-weight: bold; color: white; margin-bottom: 10px; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .special-btn:disabled { background: #b2bec3 !important; cursor: not-allowed; opacity: 0.5; }
        #random-btn { background: var(--purple); }
        #sudden-death-btn { background: var(--dark); border: 2px solid var(--danger); }

        #persistent-bomb-banner { position: fixed; top: 0; left: 0; width: 100%; background: linear-gradient(135deg, #d63031, #ff7675); color: white; padding: 15px 0; text-align: center; font-weight: 900; z-index: 50000; box-shadow: 0 5px 20px rgba(214, 48, 49, 0.5); display: none; flex-direction: column; align-items: center; animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        .bomb-banner-title { font-size: 1.3rem; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .bomb-banner-timer { font-size: 1rem; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 20px; }
        
        .agreement-box { background: rgba(0,0,0,0.03); border: 1px solid #dfe6e9; padding: 15px; border-radius: 12px; width: 80%; font-size: 0.9rem; line-height: 1.5; color: #636e72; text-align: left; }
        .agreement-box label { display: flex; align-items: center; font-weight: 800; color: var(--danger); margin-top: 10px; font-size: 1.1rem; cursor: pointer; }
        .agreement-box input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; accent-color: var(--danger); }

        /* ê°€ì´ë“œë¶ ìŠ¤íƒ€ì¼ */
        .guide-section { text-align: left; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .guide-section:last-child { border-bottom: none; }
        .guide-title { font-size: 1.2rem; font-weight: 900; color: var(--blue); margin-bottom: 8px; display: flex; align-items: center; }
        .guide-text { font-size: 0.95rem; color: #636e72; line-height: 1.6; }
        .guide-highlight { color: var(--danger); font-weight: bold; background: rgba(255, 118, 117, 0.1); padding: 0 4px; border-radius: 4px; }
        .guide-item { background: #f9f9f9; padding: 10px; border-radius: 8px; margin: 5px 0; font-size: 0.9rem; border-left: 3px solid #dfe6e9; }
        .item-name { font-weight: bold; color: #2d3436; margin-right: 5px; }
        .item-desc { color: #636e72; font-size: 0.85rem; display: block; margin-top: 2px; }
        
        .help-btn { position: absolute; top: 15px; right: 15px; width: 30px; height: 30px; border-radius: 50%; background: #dfe6e9; color: #636e72; font-weight: bold; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <audio id="sfx-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sfx-warning" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <audio id="sfx-success" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <div id="persistent-bomb-banner">
        <div class="bomb-banner-title">ğŸ’£ í­íƒ„ ì†Œì§€ ì¤‘! ë¹¨ë¦¬ ë„˜ê¸°ì„¸ìš”!</div>
        <div class="bomb-banner-timer"><span id="p-bomb-timer"></span>í„´ ë’¤ í­ë°œ!</div>
    </div>

    <div id="login-screen">
        <h1 style="color:var(--danger); font-size:3rem; margin-bottom:10px;">JURUMABLE</h1>
        
        <button onclick="openGuide()" style="width:80%; padding:10px; margin-bottom:15px; background:white; border:2px solid var(--blue); color:var(--blue); border-radius:15px; font-weight:bold;">ğŸ“– ê²Œì„ ì„¤ëª…ì„œ (í•„ë…)</button>

        <div class="agreement-box">
            âš ï¸ <b>ê²Œì„ ì‹œì‘ ì „ í•„ìˆ˜ ë™ì˜</b><br>
            ë³¸ ê²Œì„ì˜ ë£°ì— ë”°ë¼ ë²Œì¹™ ìˆ˜í–‰ì„ ê±°ë¶€í•˜ê±°ë‚˜ ì‹¤íŒ¨í•  ê²½ìš°, 
            <span style="color:var(--danger); font-weight:bold;">ì¤€ë¹„ëœ [ë²Œì£¼]ë¥¼ ë§ˆì‹œëŠ” ê²ƒ</span>ì— ë™ì˜í•˜ì‹­ë‹ˆê¹Œ?
            <label>
                <input type="checkbox" id="agree-checkbox">
                ë™ì˜í•©ë‹ˆë‹¤
            </label>
        </div>

        <div class="char-grid">
            <div class="char-btn selected" onclick="selectChar('c1', this)">ğŸ¶</div>
            <div class="char-btn" onclick="selectChar('c2', this)">ğŸ±</div>
            <div class="char-btn" onclick="selectChar('c3', this)">ğŸ­</div>
            <div class="char-btn" onclick="selectChar('c4', this)">ğŸ¹</div>
            <div class="char-btn" onclick="selectChar('c5', this)">ğŸ°</div>
            <div class="char-btn" onclick="selectChar('c6', this)">ğŸ¦Š</div>
            <div class="char-btn" onclick="selectChar('c7', this)">ğŸ»</div>
            <div class="char-btn" onclick="selectChar('c8', this)">ğŸ¼</div>
        </div>
        <input type="hidden" id="selected-char" value="c1">
        <input type="text" id="p-name" placeholder="ë‹‰ë„¤ì„">
        <button onclick="joinGame()" style="width:80%; padding:15px; margin-top:20px; background:var(--blue); color:white; border:none; border-radius:15px; font-weight:bold;">ì…ì¥í•˜ê¸°</button>
    </div>

    <div id="game-screen">
        <div class="card">
            <button class="help-btn" onclick="openGuide()">?</button>
            <h2 id="my-name" style="margin:0;"></h2>
            <div id="my-stats" style="color:#636e72;">ğŸ“ ì¶œë°œ</div>
        </div>
        
        <div id="spy-panel">
            <div style="background:var(--danger); color:white; padding:5px 15px; border-radius:20px; display:inline-block; margin-bottom:10px;">ğŸ•µï¸ SPY MISSION</div>
            <div id="spy-title" style="font-weight:bold; font-size:1.2rem;"></div>
            <div id="spy-desc" style="font-size:0.9rem; color:#666; margin-bottom:10px;"></div>
            <div id="spy-count" style="font-weight:bold; color:var(--point);">0 / 0</div>
            <button onclick="progressSpy()" style="width:100%; padding:10px; margin-top:10px; background:var(--point); color:white; border:none; border-radius:10px;">ë¯¸ì…˜ 1íšŒ ìˆ˜í–‰!</button>
        </div>

        <button id="dice-btn" onclick="rollDice()">ğŸ²</button>
        <button id="slot-trigger-btn" class="ctrl-btn" onclick="triggerSlot()">ğŸ° ë ˆë²„ ë‹¹ê¸°ê¸°!</button>
        <button id="roulette-trigger-btn" class="ctrl-btn" onclick="triggerRoulette()">âš”ï¸ ë£°ë › ëŒë¦¬ê¸°!</button>

        <button id="random-btn" class="special-btn" onclick="triggerRandomGame()">ğŸ”€ ì™¸ë¶€ ëœë¤ ê²Œì„ í˜¸ì¶œ</button>
        <button id="sudden-death-btn" class="special-btn" onclick="triggerSuddenDeath()">â˜ ï¸ ì„œë“ ë°ìŠ¤ ë°œë™ (HOST)</button>

        <h3 id="status-msg" style="color:#b2bec3;">ëŒ€ê¸° ì¤‘...</h3>
        <button onclick="openInventory()" style="width:85%; padding:15px; background:white; border:2px solid var(--gold); border-radius:15px; color:#2d3436; font-weight:bold;">ğŸ’ ë‚´ ê°€ë°© ì—´ê¸°</button>
    </div>

    <div id="guide-modal" class="modal">
        <div class="modal-content" style="text-align:left;">
            <h2 style="text-align:center; color:var(--text); margin-bottom:20px;">ğŸ“– ì£¼ë£¨ë§ˆë¸” ê°€ì´ë“œë¶</h2>
            
            <div class="guide-section">
                <div class="guide-title">ğŸ•¹ï¸ ê²Œì„ ë°©ë²•</div>
                <div class="guide-text">
                    1. ë³¸ì¸ ì°¨ë¡€ì— <b>[ğŸ² ì£¼ì‚¬ìœ„]</b>ë¥¼ êµ´ë ¤ ì´ë™í•©ë‹ˆë‹¤.<br>
                    2. ë„ì°©í•œ ì¹¸ì˜ ë¯¸ì…˜ì´ë‚˜ ë²Œì¹™ì„ ìˆ˜í–‰í•˜ì„¸ìš”.<br>
                    3. <b>[ğŸ’ ê°€ë°©]</b>ì—ì„œ íšë“í•œ ì•„ì´í…œì„ ì „ëµì ìœ¼ë¡œ ì‚¬ìš©í•˜ì„¸ìš”!
                </div>
            </div>

            <div class="guide-section">
                <div class="guide-title">ğŸ’£ í­íƒ„ ì‹œìŠ¤í…œ</div>
                <div class="guide-text">
                    <b>1. ì‹œí•œí­íƒ„:</b> 12ë²ˆ ì¹¸ì—ì„œ íšë“. <span class="guide-highlight">ì ‘ì´‰ ì‹œ í­íƒ„ ì „ì—¼!</span> 0ì´ˆê°€ ë˜ë©´ í„°ì§‘ë‹ˆë‹¤.<br>
                    <b>2. í•¨ì • í­íƒ„:</b> ë§µ ì–´ë”˜ê°€ì— ìˆ¨ê²¨ì ¸ ìˆìŠµë‹ˆë‹¤. ë°Ÿìœ¼ë©´ ì¦‰ì‹œ í„°ì§‘ë‹ˆë‹¤!<br>
                    <b>ğŸ‘¿ ë²Œì¹™ ì˜ˆì‹œ:</b><br>
                    - <span class="guide-highlight">ğŸ‘„ ì§„ì‹¤ì˜ ì… (ì•½ 45%)</span>: ê³¤ë€í•œ ì§ˆë¬¸ì— ì§„ì‹¤ ëŒ€ë‹µ<br>
                    - ğŸ’£ í­íƒ„ ëŒë¦¬ê¸°: í­íƒ„ì„ ë‚¨ì—ê²Œ ì¦‰ì‹œ ë„˜ê¹€<br>
                    - ğŸ”‡ ë¬´ìŒ ëª¨ë“œ, ğŸ‘» ë¬¼ê·€ì‹ , ğŸ¤´ ì¤‘2ë³‘ ëŒ€ì‚¬ ë“±
                </div>
            </div>

            <div class="guide-section">
                <div class="guide-title">ğŸ•µï¸ ìŠ¤íŒŒì´ (Secret)</div>
                <div class="guide-text">
                    ê²Œì„ ì¤‘ <b>ëœë¤ìœ¼ë¡œ í•œ ëª…ì´ ìŠ¤íŒŒì´</b>ê°€ ë©ë‹ˆë‹¤.<br>
                    ìŠ¤íŒŒì´ëŠ” ë‚¨ë“¤ ëª°ë˜ <b>[ë¹„ë°€ ë¯¸ì…˜]</b>ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.<br>
                    ì„±ê³µ ì‹œ: ì‹œë¯¼ ì „ì› ë²Œì£¼ / ì‹¤íŒ¨ ì‹œ: ìŠ¤íŒŒì´ ë²Œì£¼<br>
                    <span class="guide-highlight">ğŸš¨ 'ìŠ¤íŒŒì´ ì‹ ê³ ê¶Œ'ìœ¼ë¡œ ì¡ì•„ë‚´ì„¸ìš”!</span>
                </div>
            </div>

            <div class="guide-section">
                <div class="guide-title">ğŸ—ï¸ í™©ê¸ˆì—´ì‡  ë„ê° (ì „ì²´)</div>
                
                <div style="font-weight:bold; color:var(--point); margin-top:10px;">ğŸ’ ë³´ê´€í˜• ì•„ì´í…œ (ì¸ë²¤í† ë¦¬)</div>
                <div class="guide-item"><span class="item-name">ğŸ›¡ï¸ ì‹¤ë“œ:</span> <span class="item-desc">ë‹¤ìŒ ë²Œì¹™ 1íšŒë¥¼ ë°©ì–´í•©ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸª ë°˜ì‚¬:</span> <span class="item-desc">ì§€ëª©ë‹¹í•œ ë²Œì¹™ì„ ìƒëŒ€ì—ê²Œ ë˜ëŒë¦½ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸŒˆ ë¬´ì§€ê°œ ë°˜ì‚¬:</span> <span class="item-desc">ë°˜ì‚¬ì¡°ì°¨ ëš«ì–´ë²„ë¦¬ëŠ” ì ˆëŒ€ ë°©ì–´ê¶Œì…ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ¦¸ í‘ê¸°ì‚¬:</span> <span class="item-desc">ë‚´ê°€ ë§ˆì…”ì•¼ í•  ë•Œ ë‹¤ë¥¸ ì‚¬ëŒì„ ì§€ì •í•©ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸŒ€ ì†Œí™˜ê¶Œ:</span> <span class="item-desc">ì›í•˜ëŠ” í”Œë ˆì´ì–´ë¥¼ ë‚´ ìœ„ì¹˜ë¡œ ê°•ì œ ì´ë™ì‹œí‚µë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ‘¼ ë¶€í™œê¶Œ:</span> <span class="item-desc">ì£¼ëŸ‰ ì´ˆê³¼ ìœ„ê¸° ì‹œ 1íšŒ ë©´ì œë°›ìŠµë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸš¨ ìŠ¤íŒŒì´ ì‹ ê³ ê¶Œ:</span> <span class="item-desc">ì˜ì‹¬ë˜ëŠ” ìŠ¤íŒŒì´ë¥¼ ì§€ëª©í•˜ì—¬ ê²€ê±°í•©ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ’£ í­íƒ„ ëŒë¦¬ê¸°:</span> <span class="item-desc">ê°€ì§€ê³  ìˆëŠ” í­íƒ„ì„ ì§€ëª©í•œ ì‚¬ëŒì—ê²Œ ë„˜ê¹ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ›¡ï¸ [ê°•ì²  ë°©íŒ¨]:</span> <span class="item-desc">í­íƒ„ì´ í„°ì§ˆ ë•Œ ìë™ìœ¼ë¡œ ë°œë™í•˜ì—¬ ë°©ì–´í•©ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ’˜ ëŸ¬ë¸Œìƒ· ë©”ì´ì»¤:</span> <span class="item-desc">ë‘ ëª…ì„ ì§€ì •í•˜ì—¬ ê°•ì œ ëŸ¬ë¸Œìƒ·ì„ ì‹œí‚µë‹ˆë‹¤.</span></div>

                <div style="font-weight:bold; color:var(--gold); margin-top:15px;">âš¡ ì¦‰ì‹œ ë°œë™í˜• (ë½‘ìë§ˆì!)</div>
                <div class="guide-item"><span class="item-name">ğŸ™Š ìˆ ìë¦¬ ê¸ˆì§€ì–´:</span> <span class="item-desc">ì •í•œ ë‹¨ì–´ë¥¼ ë§í•  ë•Œë§ˆë‹¤ ë§ˆì…”ì•¼ í•©ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ§ª ì£¼ì¡°ì‚¬:</span> <span class="item-desc">ë‹¤ìŒ ë²Œì£¼ë¥¼ ì§ì ‘ ì œì¡°í•  ê¶Œë¦¬ë¥¼ ì–»ìŠµë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ¯ ì €ê²©ìˆ˜:</span> <span class="item-desc">íŠ¹ì • í”Œë ˆì´ì–´ë¥¼ ì§€ì •í•´ ì¦‰ì‹œ í•œ ì” ë¨¹ì…ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸš« ê¸ˆì£¼ë ¹:</span> <span class="item-desc">í•œ ë°”í€´ ëŒ ë•Œê¹Œì§€ ëª¨ë“  ê³µê²©/ì§€ëª©ì„ ë¬´ì‹œí•©ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ’ ë³´ë¬¼ì°¾ê¸°:</span> <span class="item-desc">ë³´ê´€í˜• ì•„ì´í…œ ì¹´ë“œ 2ì¥ì„ ì¦‰ì‹œ íšë“í•©ë‹ˆë‹¤!</span></div>
                <div class="guide-item"><span class="item-name">ğŸ” [ì•ˆì „ ì ê²€]:</span> <span class="item-desc">1ì´ˆê°„ ì„¤ì¹˜ëœ í­íƒ„ê³¼ ì‹œí•œí­íƒ„ ìœ„ì¹˜ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">â›ï¸ [í­íƒ„ ì„¤ì¹˜]:</span> <span class="item-desc">ë§µ ì–´ë”˜ê°€ì— ë³´ì´ì§€ ì•ŠëŠ” í•¨ì • í­íƒ„ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ¤« [ì¹¨ë¬µì˜ ìˆ˜í–‰]:</span> <span class="item-desc">ë‹¤ìŒ í„´ê¹Œì§€ ë§ì„ í•˜ë©´ ì¦‰ì‹œ ë§ˆì…”ì•¼ í•©ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ”« ëŸ¬ì‹œì•ˆ ë£°ë ›:</span> <span class="item-desc">ì„¸ ì” ì¤‘ ì†Œì£¼ í•œ ì”ì„ ê³ ë¥´ëŠ” ë³µë¶ˆë³µ ê²Œì„ì…ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ» [ë°˜ê°€ì›Œìš”]:</span> <span class="item-desc">ì „ì› ê±´ë°° ë° ë‹¤ ê°™ì´ í•œ ì” ë§ˆì‹­ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ—½ [ì™¸êµ­ì–´ ê¸ˆì§€]:</span> <span class="item-desc">10ë¶„ ë™ì•ˆ ì˜ì–´ë¥¼ ì“°ë©´ ë¬´ì¡°ê±´ ì›ìƒ·ì…ë‹ˆë‹¤.</span></div>
                <div class="guide-item"><span class="item-name">ğŸ‘„ ì§„ì‹¤ì˜ ì…:</span> <span class="item-desc">ì§€ê¸ˆ ì¦‰ì‹œ ê³¤ë€í•œ ì§ˆë¬¸ì— ì§„ì‹¤ì„ ë§í•´ì•¼ í•©ë‹ˆë‹¤.</span></div>
            </div>

            <div class="guide-section" style="background:#fff0f0; border:1px solid var(--danger); padding:10px; border-radius:10px;">
                <div class="guide-title" style="color:var(--danger);">âš ï¸ ì ˆëŒ€ ê·œì¹™ (WARNING)</div>
                <div class="guide-text" style="font-weight:bold; text-align:center;">
                    ê²Œì„ì˜ ë²Œì¹™ì´ë‚˜ ë¯¸ì…˜ì„<br>
                    ê±°ë¶€í•  ê²½ìš°,<br>
                    <span style="font-size:1.2rem; color:#d63031;">ğŸº ë¬´ì¡°ê±´ [ë²Œì£¼] ìˆ˜í–‰!</span>
                </div>
            </div>

            <button onclick="closeModal('guide-modal')" style="width:100%; padding:15px; margin-top:10px; background:var(--dark); color:white; border:none; border-radius:10px; font-weight:bold;">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="inventory-modal" class="modal"><div class="modal-content"><h3>ğŸ’ ì•„ì´í…œ</h3><div id="inventory-list"></div><button onclick="closeModal('inventory-modal')" style="margin-top:20px; border:none; background:none; text-decoration:underline;">ë‹«ê¸°</button></div></div>
    <div id="target-modal" class="modal"><div class="modal-content"><h3>ëˆ„êµ¬ì—ê²Œ?</h3><div id="target-buttons"></div><button onclick="closeModal('target-modal')" style="margin-top:20px; border:none; background:none; text-decoration:underline;">ì·¨ì†Œ</button></div></div>
    
    <div id="rule-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ‘‘ ìƒˆë¡œìš´ ê·œì¹™ ì œì •</h3>
            <input type="text" id="rule-input" placeholder="ì˜ˆ: ì˜ì–´ ì“°ë©´ í•œ ì”" style="width:100%; margin:20px 0;">
            <button onclick="sendRule()" style="width:100%; padding:15px; background:var(--gold); border:none; border-radius:10px; font-weight:bold;">ê·œì¹™ ì„ í¬!</button>
        </div>
    </div>

    <div id="mobile-alert" style="display:none; position:fixed; width:100%; height:100%; top:0; left:0; background:rgba(0,0,0,0.85); z-index:99999; justify-content:center; align-items:center; flex-direction:column; padding:20px; text-align:center; color:white; animation: fadeIn 0.3s;">
        <div id="m-alert-icon" style="font-size:5rem; margin-bottom:15px; animation: bounce 1s infinite;">ğŸ’Œ</div>
        <div id="m-alert-title" style="font-size:2rem; font-weight:900; color:#fdcb6e; margin-bottom:10px;"></div>
        <div id="m-alert-desc" style="font-size:1.2rem; color:#dfe6e9; margin-bottom:30px; word-break:keep-all;"></div>
        <button onclick="closeMobileAlert()" style="padding:15px 40px; font-size:1.2rem; font-weight:bold; background:var(--blue); color:white; border:none; border-radius:50px; box-shadow:0 10px 20px rgba(9,132,227,0.4);">í™•ì¸í–ˆìŠµë‹ˆë‹¤</button>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyB8vzF10M-hkk1eBHSsHDHlAo36TXAJVF0", authDomain: "real-jurumable.firebaseapp.com", projectId: "real-jurumable", storageBucket: "real-jurumable.firebasestorage.app", messagingSenderId: "481733347334", appId: "1:481733347334:web:dff7506e01dc200fbe9b87" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myId = localStorage.getItem('jurumable_pid');
        let me = {}; let allPlayers = {};
        let selectedItemIndex = -1, selectedItemName = "";
        let globalBombTimer = 0; 

        function playSound(type) {
            const audio = document.getElementById(`sfx-${type}`);
            if (audio) { audio.currentTime = 0; audio.play().catch(e => console.log("Sound autoplay prevented:", e)); }
        }

        function selectChar(c,e){ playSound('click'); document.querySelectorAll('.char-btn').forEach(b=>b.classList.remove('selected')); e.classList.add('selected'); document.getElementById('selected-char').value=c; }
        
        function joinGame(){
            if(!document.getElementById('agree-checkbox').checked) {
                playSound('warning');
                return alert("âš ï¸ ë²Œì¹™ ìˆ˜í–‰ì— ë™ì˜í•˜ëŠ” ì²´í¬ë°•ìŠ¤ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
            }

            playSound('success');
            const n=document.getElementById('p-name').value;
            if(!n)return alert("ì´ë¦„!");
            if(!myId){myId='p_'+Math.random().toString(36).substr(2,9);localStorage.setItem('jurumable_pid',myId);}
            db.ref(`users/${myId}`).set({name:n,char:document.getElementById('selected-char').value,location:0,drinks:0,isMyTurn:false,isWaitResult:false,inventory:[]});
            document.getElementById('login-screen').style.display='none';
            document.getElementById('game-screen').style.display='flex';
            startListen();
        }

        function startListen(){
            db.ref('game/reset').on('value', s => {
                if(s.val() === true) {
                    localStorage.removeItem('jurumable_pid');
                    location.reload();
                }
            });

            db.ref('game/bombTimer').on('value', s => {
                globalBombTimer = s.val() || 0;
                document.getElementById('p-bomb-timer').innerText = globalBombTimer;
            });

            db.ref(`users/${myId}`).on('value',s=>{
                me=s.val(); if(!me)return;
                document.getElementById('my-name').innerText=me.name;
                document.getElementById('my-stats').innerText=`ğŸ“ ${me.location||0}ë²ˆì¹¸`;
                
                if(me.hasBomb) {
                    document.getElementById('persistent-bomb-banner').style.display = 'flex';
                } else {
                    document.getElementById('persistent-bomb-banner').style.display = 'none';
                }

                const dBtn = document.getElementById('dice-btn');
                const sBtn = document.getElementById('slot-trigger-btn');
                const rBtn = document.getElementById('roulette-trigger-btn');
                const msg = document.getElementById('status-msg');
                const rndBtn = document.getElementById('random-btn');
                const sdnBtn = document.getElementById('sudden-death-btn');

                dBtn.style.display = 'flex'; sBtn.style.display = 'none'; rBtn.style.display = 'none';

                // [NEW] ì¹¸ ë„ì°©í•´ì„œ ì§€ëª© ìš”ì²­ì´ ì™”ì„ ë•Œ (ìë™ íŒì—…)
                if(me.reqTarget) {
                    dBtn.style.display = 'none';
                    msg.innerText = "ğŸ‘‰ ìƒëŒ€ë¥¼ ì§€ëª©í•˜ì„¸ìš”!";
                    
                    document.getElementById('target-modal').style.display = 'flex';
                    
                    // í˜¸ìŠ¤íŠ¸ì— "ë‚˜ ì§€ëª© ì¤‘ì´ì•¼" ì˜¤ë²„ë ˆì´ ë„ìš°ê¸° ì‹ í˜¸
                    db.ref('game/targeting').set({playerId: myId, item: me.reqTarget});
                    
                    const list = document.getElementById('target-buttons'); 
                    list.innerHTML = "";
                    Object.keys(allPlayers).forEach(k => {
                        if(k === myId) return; 
                        const b = document.createElement('button'); 
                        b.className = 'target-btn'; 
                        b.innerText = allPlayers[k].name;
                        // í´ë¦­ ì‹œ ì¹¸ ì§€ëª© ì „ì†¡ í•¨ìˆ˜(sendTargetCell) í˜¸ì¶œ
                        b.onclick = () => { if(confirm(allPlayers[k].name + "ë‹˜ì„ ì§€ëª©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) sendTargetCell(k); };
                        list.appendChild(b);
                    });
                }
                else if(me.reqSlot) { 
                    dBtn.style.display = 'none'; sBtn.style.display = 'block';
                    msg.innerText = "ğŸ° ë ˆë²„ë¥¼ ë‹¹ê¸°ì„¸ìš”!";
                } else if(me.reqRoulette) { 
                    dBtn.style.display = 'none'; rBtn.style.display = 'block';
                    msg.innerText = "âš”ï¸ ë£°ë ›ì„ ëŒë¦¬ì„¸ìš”!";
                } else if(me.reqRule) { 
                    document.getElementById('rule-modal').style.display = 'flex';
                } else if(me.isWaitResult) {
                    dBtn.disabled=true; dBtn.style.opacity="0.5"; 
                    rndBtn.disabled=true; sdnBtn.disabled=true;
                    msg.innerText="ê²°ê³¼ í™•ì¸ ì¤‘...";
                } else if(me.isMyTurn) {
                    dBtn.disabled=false; dBtn.style.opacity="1"; 
                    rndBtn.disabled=false; sdnBtn.disabled=false;
                    msg.innerText="ğŸ”¥ ë‹¹ì‹  ì°¨ë¡€!";
                } else {
                    dBtn.disabled=true; dBtn.style.opacity="0.5"; 
                    rndBtn.disabled=true; sdnBtn.disabled=true;
                    msg.innerText="ëŒ€ê¸° ì¤‘...";
                }

                const spy = document.getElementById('spy-panel');
                if(me.spyMission) {
                    spy.style.display = 'block';
                    document.getElementById('spy-title').innerText = me.spyMission.title;
                    document.getElementById('spy-desc').innerText = me.spyMission.desc;
                    document.getElementById('spy-count').innerText = `${me.spyMission.current} / ${me.spyMission.total}`;
                } else spy.style.display = 'none';
            });
            db.ref('users').on('value',s=>{allPlayers=s.val()||{}});

            db.ref(`users/${myId}/personalAlert`).on('value', s => {
                const data = s.val();
                if(data) {
                    playSound('warning');
                    if(navigator.vibrate) navigator.vibrate(500); 
                    document.getElementById('mobile-alert').style.display = 'flex';
                    document.getElementById('m-alert-icon').innerText = data.icon || 'ğŸ’Œ';
                    document.getElementById('m-alert-title').innerText = data.title;
                    document.getElementById('m-alert-desc').innerHTML = data.desc;
                    db.ref(`users/${myId}/personalAlert`).set(null); 
                }
            });
        }

        function openGuide() {
            playSound('click');
            document.getElementById('guide-modal').style.display = 'flex';
        }

        function rollDice(){ playSound('click'); db.ref(`users/${myId}/isWaitResult`).set(true); db.ref('game/event').push({type:'request_roll',playerId:myId}); }
        function triggerSlot(){ playSound('click'); db.ref(`users/${myId}/reqSlot`).set(null); db.ref('game/slotTrigger').set(myId); }
        function triggerRoulette(){ 
            playSound('click');
            const opponent = me.reqRoulette.opponent;
            db.ref(`users/${myId}/reqRoulette`).set(null); 
            db.ref('game/rouletteTrigger').set({p1:myId, p2:opponent}); 
        }

        function triggerRandomGame() {
            playSound('click');
            if(confirm("ì™¸ë¶€ ëœë¤ ê²Œì„ì„ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                db.ref('game/event').push({type:'request_random_game', playerId:myId});
                db.ref(`users/${myId}/isWaitResult`).set(true); 
            }
        }

        function triggerSuddenDeath() {
            playSound('warning');
            if(confirm("ì •ë§ ê²Œì„ì„ ì„œë“ ë°ìŠ¤ ëª¨ë“œë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!)")) {
                db.ref('game/status').update({ suddenDeath: true });
                db.ref('game/event').push({type:'sudden_death_triggered', playerId:myId});
            }
        }

        function progressSpy() {
            if(!me.spyMission) return;
            playSound('click');
            const newCount = (me.spyMission.current || 0) + 1;
            db.ref('game/spyProgress').set({ text: me.spyMission.title, total: me.spyMission.total, current: newCount });

            if(newCount >= me.spyMission.total) {
                if(confirm("ë¯¸ì…˜ ëª©í‘œ ë‹¬ì„±! ì„±ê³µì„ ì„ ì–¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(TVì— ì •ì²´ê°€ ê³µê°œë©ë‹ˆë‹¤)")) {
                    db.ref('game/spyClaim').set({spyId:myId, isFail:false});
                    db.ref(`users/${myId}/spyMission`).set(null);
                } else {
                    db.ref(`users/${myId}/spyMission/current`).set(newCount);
                }
            } else {
                db.ref(`users/${myId}/spyMission/current`).set(newCount);
                alert(`ë¯¸ì…˜ ìˆ˜í–‰ í™•ì¸! (${newCount}/${me.spyMission.total})`);
            }
        }

        function sendRule() {
            const rule = document.getElementById('rule-input').value;
            if(!rule) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");
            playSound('success');
            db.ref('game/newRule').set(rule);
            db.ref(`users/${myId}/reqRule`).set(null);
            document.getElementById('rule-modal').style.display = 'none';
        }

        function openInventory(){
            playSound('click');
            const list=document.getElementById('inventory-list'); list.innerHTML="";
            (me.inventory||[]).forEach((item,i)=>{
                const b=document.createElement('div'); b.className='item-btn';
                b.innerHTML=`${item.name} <span style="color:#aaa;float:right;">ì‚¬ìš©</span>`;
                b.onclick=()=>prepareItem(i,item); list.appendChild(b);
            });
            document.getElementById('inventory-modal').style.display='flex';
        }

        function prepareItem(i, item){
            // [NEW] ì•„ì´í…œ í„°ì¹˜ ì‹œ ì„¤ëª… íŒì—… ë° ì‚¬ìš© í™•ì¸ ê¸°ëŠ¥ ì¶”ê°€
            if(!confirm(`[ ${item.name} ]\n\n${item.desc}\n\nì´ ì•„ì´í…œì„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            selectedItemIndex=i; selectedItemName=item.name;
            const needsTarget = ["ì§€ëª©", "ë°˜ì‚¬", "í‘ê¸°ì‚¬", "ëŒ€ë¦¬", "ì €ê²©", "ë¬¼ê·€ì‹ ", "ì†Œí™˜", "ì‹ ê³ ", "ëŒë¦¬ê¸°", "ëŸ¬ë¸Œìƒ·"];
            if(needsTarget.some(k=>item.name.includes(k))) {
                // [NEW] ì•„ì´í…œ ì§€ëª© ì‹œì—ë„ TV ì˜¤ë²„ë ˆì´ ë„ìš°ê¸°
                db.ref('game/targeting').set({playerId: myId, item: item.name});

                document.getElementById('inventory-modal').style.display='none';
                const list=document.getElementById('target-buttons'); list.innerHTML="";
                Object.keys(allPlayers).forEach(k=>{
                    if(k===myId)return;
                    const b=document.createElement('button'); b.className='target-btn'; b.innerText=allPlayers[k].name;
                    b.onclick=()=>{ if(confirm(allPlayers[k].name+"ë‹˜ì—ê²Œ ì‚¬ìš©?")) sendItem(k); };
                    list.appendChild(b);
                });
                document.getElementById('target-modal').style.display='flex';
            } else {
                // ì´ë¯¸ ìœ„ì—ì„œ confirm í–ˆìœ¼ë¯€ë¡œ ë°”ë¡œ ì „ì†¡
                sendItem(null);
            }
        }

        function sendItem(tid){
            playSound('success');
            // [NEW] ì‚¬ìš© ì™„ë£Œ ì‹œ TV ì˜¤ë²„ë ˆì´ ë„ê¸°
            db.ref('game/targeting').set(null);

            db.ref('game/event').push({type:'item_use', playerId:myId, itemName:selectedItemName, targetId:tid});
            const nextInv = me.inventory.filter((_,i)=>i!==selectedItemIndex);
            db.ref(`users/${myId}/inventory`).set(nextInv);
            closeModal('inventory-modal'); closeModal('target-modal');
        }

        // [NEW] ì¹¸ ë„ì°© ì§€ëª© ì „ì†¡ í•¨ìˆ˜
        function sendTargetCell(tid) {
            playSound('success');
            db.ref('game/event').push({
                type: 'cell_target', 
                playerId: myId, 
                targetId: tid, 
                cellName: me.reqTarget
            });
            
            db.ref(`users/${myId}/reqTarget`).set(null); 
            db.ref('game/targeting').set(null); 
            closeModal('target-modal');
        }

        function closeModal(id){ 
            // [NEW] ì°½ ë‹«ìœ¼ë©´ TV ì•Œë¦¼ë„ ë„ê¸°
            if(id === 'target-modal') db.ref('game/targeting').set(null);
            document.getElementById(id).style.display='none'; 
        }
        function closeMobileAlert() { playSound('click'); document.getElementById('mobile-alert').style.display = 'none'; }
    </script>
</body>
</html>