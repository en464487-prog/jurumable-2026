<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì£¼ë£¨ë§ˆë¸” ì»¨íŠ¸ë¡¤ëŸ¬</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --bg: #1a1c20; --card: #2d3139; --point: #4cd964; --danger: #ff3b30; }
        body { background: var(--bg); color: white; font-family: sans-serif; text-align: center; padding: 20px; user-select: none; }
        .box { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        input { width: 100%; background: transparent; border: none; border-bottom: 2px solid #555; color: white; font-size: 20px; text-align: center; padding: 10px; }
        
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .char-item { font-size: 30px; padding: 10px; background: #333; border-radius: 10px; filter: grayscale(1); }
        .char-item.active { filter: grayscale(0); border: 2px solid var(--point); transform: scale(1.1); }
        
        .btn { background: var(--point); width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; margin-top: 15px; color: black; }
        .btn-dice { background: white; color: black; font-size: 20px; box-shadow: 0 4px 10px rgba(255,255,255,0.2); }
        .btn-bomb { background: var(--danger); color: white; animation: shake 0.5s infinite; display: none; }
        
        .drink-btn { width: 90px; height: 90px; border-radius: 50%; background: #ffd700; border: none; font-size: 20px; font-weight: bold; margin: 20px auto; display: block; box-shadow: 0 0 20px rgba(255,215,0,0.5); color: black; }
        
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        
        #gameScreen { display: none; }
        #alertOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:999; }
    </style>
</head>
<body>
    <div id="loginScreen">
        <h2>ğŸ² ì£¼ë£¨ë§ˆë¸” ì…ì¥</h2>
        <div class="box"><input type="text" id="name" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (5ì ì´ë‚´)" maxlength="5"></div>
        <div class="char-grid" id="charList"></div>
        <button class="btn" onclick="enterGame()">ì…ì¥í•˜ê¸°</button>
    </div>

    <div id="gameScreen">
        <h3 id="displayInfo">ëŒ€ê¸° ì¤‘...</h3>
        
        <button class="btn btn-dice" onclick="rollDice()">ğŸ² ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°</button>
        <p id="diceResult" style="font-size: 24px; color: #ffd700; font-weight: bold; min-height: 30px;"></p>

        <button id="passBombBtn" class="btn btn-bomb" onclick="passBomb()">ğŸ’£ í­íƒ„ ë„˜ê¸°ê¸°!</button>

        <div style="margin-top: 30px; padding-top:20px; border-top:1px solid #444;">
            <p style="color:#888; font-size:12px;">ë§ˆì‹  ì” ìˆ˜ (ë‚˜ë§Œ ë³´ì„)</p>
            <button class="drink-btn" onclick="addDrink()">ğŸº<br><span id="drinkCount">0</span>ì”</button>
        </div>

        <button class="btn" style="background:#555; color:white; margin-top:30px;" onclick="sendVote()">ğŸ‘‰ ì§€ëª© íˆ¬í‘œí•˜ê¸°</button>
    </div>

    <div id="alertOverlay" onclick="this.style.display='none'">
        <h1 id="alertEmoji" style="font-size:80px;">âš ï¸</h1>
        <h2 id="alertText" style="color:white; text-align:center; padding:20px;">ì•Œë¦¼</h2>
    </div>

    <script src="game_config.js"></script>
    <script>
        let myId = Date.now().toString();
        let myChar = null;
        let myDrinks = 0;
        let db;

        // ì´ˆê¸°í™”
        window.onload = function() {
            const grid = document.getElementById('charList');
            GAME_CONFIG.characters.forEach(c => {
                let d = document.createElement('div');
                d.className = 'char-item';
                d.innerHTML = c.emoji;
                d.onclick = () => {
                    document.querySelectorAll('.char-item').forEach(e=>e.classList.remove('active'));
                    d.classList.add('active');
                    myChar = c.id;
                };
                grid.appendChild(d);
            });
        }

        function enterGame() {
            const name = document.getElementById('name').value;
            if(!name || !myChar) return alert('ë‹‰ë„¤ì„ê³¼ ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
            
            db = firebase.database();
            db.ref('users/' + myId).set({
                name: name, char: myChar, drinks: 0, 
                status: 'normal', lastRoll: 0
            });

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('displayInfo').innerText = `${GAME_CONFIG.characters.find(c=>c.id===myChar).emoji} ${name}`;

            // *** ì‹¤ì‹œê°„ ìƒíƒœ ê°ì‹œ ***
            db.ref('users/' + myId).on('value', snap => {
                const data = snap.val();
                if(!data) return;

                // í­íƒ„ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
                const bombBtn = document.getElementById('passBombBtn');
                if(data.status === 'bomb') {
                    bombBtn.style.display = 'block';
                    showAlert('ğŸ’£', 'í­íƒ„ì´ ë¶€ì°©ë˜ì—ˆìŠµë‹ˆë‹¤! ë¹¨ë¦¬ ë„˜ê¸°ì„¸ìš”!');
                } else {
                    bombBtn.style.display = 'none';
                }

                if(data.status === 'spy') showAlert('ğŸ•µï¸', 'ë‹¹ì‹ ì€ ìŠ¤íŒŒì´ì…ë‹ˆë‹¤. ë¯¸ì…˜ì„ ìˆ˜í–‰í•˜ì„¸ìš”!');
                if(data.status === 'master') showAlert('ğŸ‘‘', 'ë§ˆìŠ¤í„° í‚¤ íšë“! 1í„´ê°„ ë¬´ì ì…ë‹ˆë‹¤.');
            });

            // ì „ì²´ ì•Œë¦¼(ê²°íˆ¬ ë“±) ê°ì‹œ
            db.ref('gameEvent').on('value', snap => {
                if(snap.val()) showAlert('ğŸ“¢', snap.val().message);
            });
        }

        function rollDice() {
            const num = Math.floor(Math.random() * 6) + 1;
            document.getElementById('diceResult').innerText = `ë‚˜ì˜¨ ìˆ«ì: ${num}`;
            // ì„œë²„ì— ì•Œë ¤ì„œ TVì— ë„ìš°ê¸°
            db.ref('diceRoll').set({ name: document.getElementById('name').value, num: num, time: Date.now() });
        }

        function addDrink() {
            myDrinks++;
            document.getElementById('drinkCount').innerText = myDrinks;
            db.ref('users/' + myId + '/drinks').set(myDrinks);
        }

        function passBomb() {
            // í­íƒ„ ë„˜ê¸°ê¸° ë¡œì§ (ê°„ë‹¨í•˜ê²Œ ëœë¤í•˜ê²Œ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ë„˜ê¹€)
            db.ref('users').once('value', snap => {
                const users = snap.val();
                const ids = Object.keys(users).filter(id => id !== myId);
                if(ids.length > 0) {
                    const targetId = ids[Math.floor(Math.random() * ids.length)];
                    db.ref('users/' + myId + '/status').set('normal'); // ë‚˜ í•´ì œ
                    db.ref('users/' + targetId + '/status').set('bomb'); // ë„ˆ ë‹¹ì²¨
                    alert('í­íƒ„ì„ ë„˜ê²¼ìŠµë‹ˆë‹¤!');
                }
            });
        }

        function sendVote() {
            const target = prompt("ëˆ„êµ¬ë¥¼ ì§€ëª©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if(target) db.ref('votes').push({target: target});
        }

        function showAlert(emoji, text) {
            document.getElementById('alertEmoji').innerText = emoji;
            document.getElementById('alertText').innerText = text;
            document.getElementById('alertOverlay').style.display = 'flex';
            if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
        }
    </script>
</body>
</html>